<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡œê·¸ì¸ ë° ì¸ì¦</title>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .container { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); width: 100%; max-width: 400px; overflow: hidden; }
        .header { background: #333; color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .header p { opacity: 0.8; font-size: 14px; }
        .content { padding: 30px; }
        .tabs { display: flex; margin-bottom: 25px; border-radius: 10px; overflow: hidden; border: 2px solid #667eea; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; background: white; color: #667eea; font-weight: 600; transition: all 0.3s; border: none; font-size: 14px; }
        .tab.active { background: #667eea; color: white; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 14px; }
        input { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; transition: border-color 0.3s; }
        input:focus { outline: none; border-color: #667eea; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-bottom: 10px; }
        .btn-primary { background: #667eea; color: white; }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .toggle-mode { text-align: center; margin-top: 20px; color: #666; font-size: 14px; }
        .toggle-mode a { color: #667eea; text-decoration: none; font-weight: 600; }
        .message { padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; display: none; }
        .message.error { background: #ffe6e6; color: #cc0000; border: 1px solid #ffcccc; display: block; }
        .message.success { background: #e6ffe6; color: #006600; border: 1px solid #ccffcc; display: block; }
        
        /* ë©”ì¼ ì¸ì¦ UI ì¶”ê°€ */
        #mail-verify-section { display: none; background: #f8faff; padding: 15px; border-radius: 10px; border: 2px dashed #667eea; margin-top: 15px; }
        #mail-verify-section.active { display: block; }

        .user-info { display: none; text-align: center; }
        .user-info.active { display: block; }
        .user-avatar { width: 80px; height: 80px; border-radius: 50%; background: #667eea; color: white; display: flex; align-items: center; justify-content: center; font-size: 32px; margin: 0 auto 20px; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 2px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>í™˜ì˜í•©ë‹ˆë‹¤</h1>
            <p>ë¡œê·¸ì¸í•˜ì—¬ ê³„ì†í•˜ì„¸ìš”</p>
        </div>

        <div class="content">
            <div id="message" class="message"></div>

            <div id="auth-section">

                <div id="email-form" class="auth-form active">
                    <form id="email-auth-form">
                        <div class="form-group">
                            <label for="email">ì´ë©”ì¼</label>
                            <input type="email" id="email" placeholder="example@email.com" required>
                        </div>
                        <div class="form-group">
                            <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" required minlength="6">
                        </div>
                        <button type="submit" class="btn btn-primary" id="email-submit-btn">ë¡œê·¸ì¸</button>
                    </form>

                    <div id="mail-verify-section">
                        <label style="color: #667eea;">ì¸ì¦ë²ˆí˜¸ ì…ë ¥</label>
                        <input type="text" id="mail-code-input" placeholder="4ìë¦¬ ìˆ«ì" maxlength="4">
                        <button type="button" class="btn btn-primary" id="mail-verify-confirm-btn" style="margin-top:10px;">ì¸ì¦ í™•ì¸ ë° ê°€ì…</button>
                    </div>

                    <p class="toggle-mode">
                        <span id="toggle-text">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?</span> <a href="#" id="toggle-signup">í´ë¦­!</a>
                    </p>
                </div>
            </div>

            <div id="user-info" class="user-info">
                <div class="user-avatar" id="user-avatar">ğŸ‘¤</div>
                <h2 id="user-name">ì‚¬ìš©ì</h2>
                <p id="user-email"></p>
                <a href="./login">
                <button class="btn btn-secondary" style="background-color:#667EEA; margin-top:30px;">ëŒì•„ê°€ê¸°</button>
                </a>
                <button class="btn btn-secondary" id="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAigYxYrge6_snzxETaz8j3jbXhY5YbZeM",
            authDomain: "project-no4-7cddf.firebaseapp.com",
            projectId: "project-no4-7cddf",
            storageBucket: "project-no4-7cddf.firebasestorage.app",
            messagingSenderId: "528275601812",
            appId: "1:528275601812:web:beecf3cbb27078667c3781"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        /* ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ */
        const message = document.getElementById('message');
        const emailSubmitBtn = document.getElementById('email-submit-btn');
        const mailVerifySection = document.getElementById('mail-verify-section');
        let isSignUp = false;

        function showMessage(text, type) {
            message.textContent = text;
            message.className = 'message ' + type;
        }

        async function getUserIP() {
            try {
                const res = await fetch('https://api.ipify.org?format=json');
                const data = await res.json();
                return data.ip;
            } catch { return 'unknown'; }
        }



        document.getElementById('toggle-signup').addEventListener('click', (e) => {
            e.preventDefault();
            isSignUp = !isSignUp;
            emailSubmitBtn.textContent = isSignUp ? 'ì¸ì¦ë²ˆí˜¸ ë°›ê¸°' : 'ë¡œê·¸ì¸';
            document.getElementById('toggle-text').textContent = isSignUp ? 'ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?' : 'ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?';
            mailVerifySection.classList.remove('active');
        });


        document.getElementById('email-auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (isSignUp) {
                const code = Math.floor(Math.random() * 9000) + 1000;
                emailSubmitBtn.disabled = true;
                emailSubmitBtn.textContent = "ë°œì†¡ ì¤‘...";
                
                try {
                    const res = await fetch('http://localhost:3000/send-welcome-email', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, code })
                    });
                    if (res.ok) {
                        showMessage('ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ë©”ì¼ì„ í™•ì¸í•˜ì„¸ìš”!', 'success');
                        mailVerifySection.classList.add('active');
                    }
                } catch (err) {
                    showMessage('ë©”ì¼ ì„œë²„ ì—°ê²° ì‹¤íŒ¨ (ì„œë²„ë¥¼ í™•ì¸í•˜ì„¸ìš”)', 'error');
                } finally {
                    emailSubmitBtn.disabled = false;
                    emailSubmitBtn.textContent = "ì¸ì¦ë²ˆí˜¸ ë‹¤ì‹œ ë°›ê¸°";
                }
            } else {
                // ë¡œê·¸ì¸
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessage('ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
                } catch (err) { showMessage(err.message, 'error'); }
            }
        });


        document.getElementById('mail-verify-confirm-btn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const userInputCode = document.getElementById('mail-code-input').value;

            try {
                const res = await fetch('http://localhost:3000/verify-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, userInputCode })
                });

                if (res.ok) {

                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await saveUserToSupabase(userCredential.user);
                    showMessage('íšŒì›ê°€ì… ë° ì¸ì¦ ì„±ê³µ!', 'success');
                } else {
                    showMessage('ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (err) { showMessage('ì¸ì¦ ì˜¤ë¥˜ ë°œìƒ', 'error'); }
        });


        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        onAuthStateChanged(auth, async (user) => {
            const authSection = document.getElementById('auth-section');
            const userInfo = document.getElementById('user-info');
            if (user) {
                authSection.style.display = 'none';
                userInfo.classList.add('active');
                document.getElementById('user-name').textContent = user.email.split('@')[0];
                document.getElementById('user-email').textContent = user.email;
                await saveUserToSupabase(user);
            } else {
                authSection.style.display = 'block';
                userInfo.classList.remove('active');
            }
        });
    </script>
</body>
</html>